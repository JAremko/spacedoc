#!/usr/bin/env bash

cd "$(dirname "$0")"

action="$1"
first_arg="$2"
shift

print_help () {
read -d '' help <<- EOF
  Spacemacs documentation tools

  usage: run ACTION [ARGS]...

  Actions:
    validate ROOT [INPUTS]... Validate Spacemacs documentation files.
                              If only the first argument is supplied
                              the default list of documentation files
                              will be used.
    format   ROOT [INPUTS]... Format Spacemacs documentation files.
                              If only the first argument is supplied
                              all files in ROOT folder will be formatted.

  Common arguments:
    ROOT   root directory of Spacemacs documentation. Example: "~/.emacs.d/".
    INPUTS are processed .org files or directories containing them.
EOF
echo "$help"
}

echo_headline () {
    printf '=%.0s' {1..70}
    printf "\n$1\n"
    printf '=%.0s' {1..70}
    echo
}

case $action in
"")
    print_help
    exit 2
    ;;
-h|--help)
    print_help
    exit 0
    ;;
esac

if [ ! -d "${first_arg}" ]; then
    print_help
    exit 2
fi

case $@ in
"")
    print_help
    exit 2
    ;;
-h|--help)
    print_help
    exit 0
    ;;
esac

case $action in
validate)
    rm -rf /opt/spacedoc/emacs_tools/export/target/*
    echo_headline "Exporting documentation for validation:"
    emacs -batch -l ./emacs_tools/export/run.el -no-site-file -q "$@"
    echo_headline "Validating documentation:"
    sdn validate /opt/spacedoc/emacs_tools/export/target/
    exit $?
    ;;
format)
    echo_headline "Reformatting documentation with Emacs tools(in place):"
    emacs -batch -l ./emacs_tools/docfmt/run.el -no-site-file -q "$@"
    rm -rf /opt/spacedoc/emacs_tools/export/target/*
    echo_headline "Exporting documentation for formatting with Clojure tools:"
    emacs -batch -l ./emacs_tools/export/run.el -no-site-file -q "$@"
    echo_headline "Importing documentation back into .org format:"
    sdn orgify /opt/spacedoc/emacs_tools/export/target/ "${first_arg}"
    exit $?
    ;;
*)
   print_help
   exit 2
  ;;
esac
